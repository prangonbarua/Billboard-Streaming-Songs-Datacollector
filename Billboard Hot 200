import os
import pandas as pd

# === PARAMETERS TO EDIT ===
artist_name = 'Drake'  # ← enter the artist name here

# Direct path with your username
file_path = '/Users/prangonbarua/Desktop/billboard200.csv'
# ===========================

# Load the data
data = pd.read_csv(file_path, low_memory=False)

# Check if all required columns are present
required_cols = {'Date', 'Song', 'Artist', 'Rank'}
if required_cols.issubset(data.columns):
    # Convert the 'Date' column to datetime
    data['Date'] = pd.to_datetime(data['Date'], errors='coerce')
    data = data.dropna(subset=['Date'])

    # Clean text fields
    data['Song'] = data['Song'].str.strip().str.lower()
    data['Artist'] = data['Artist'].str.strip().str.lower()

    # Filter by artist
    filtered_data = data[data['Artist'].str.contains(artist_name.lower(), na=False)]

    if not filtered_data.empty:
        # Create a 'Song (Artist)' column
        filtered_data = filtered_data.copy()
        filtered_data['Song_Artist'] = (
            filtered_data['Song'].str.title() + " (" + filtered_data['Artist'].str.title() + ")"
        )

        # Pivot table using actual dates from the data
        pivot_table = filtered_data.pivot_table(
            index='Date', 
            columns='Song_Artist', 
            values='Rank',
            aggfunc='first'
        )

        # Fill in missing weeks
        all_dates = pd.Series(data['Date'].unique())
        all_dates = all_dates[all_dates >= filtered_data['Date'].min()]
        pivot_table = pivot_table.reindex(pd.to_datetime(sorted(all_dates)))

        # Sort columns by first appearance
        first_appearance = filtered_data.groupby('Song_Artist')['Date'].min()
        sorted_columns = first_appearance.sort_values().index
        pivot_table = pivot_table[sorted_columns]

        # Format index as text
        pivot_table.index = pivot_table.index.strftime('%Y-%m-%d')

        # Safe filename for output
        safe_name = artist_name.title().replace(" ", "_")
        
        # Output file path to Desktop
        output_file = f'/Users/prangonbarua/Desktop/{safe_name}_Chart_History.xlsx'

        # Save to Excel
        pivot_table.to_excel(output_file)

        print(f"✅ Done! Data for '{artist_name.title()}' saved to: {output_file}")
    else:
        print(f"⚠️ No results found for artist: {artist_name}")
else:
    print("❌ Missing required columns. Found columns:", data.columns.tolist())